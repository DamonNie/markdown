<div class="post-container">
    <div class="post-header">
        <h1 class="post-title">让PHP更快的提供文件下载</h1>
        <div class="post-byline">Published on <a class="date" href="https://www.laruence.com/2012/05">2 May 2012</a> by <a class="author" href="https://www.laruence.com/author/laruence">laruence</a></div>			</div>
    <div class="post-content">

        <div class="copyright">
            <ul>
                <!--

<li>作者: <a href="https://www.laruence.com">Laruence</a>(<a href="http://www.twitter.com/laruence" target="meme" title="Twitter"><img src="/images/ico-twitter.png" /></a> <a href="http://t.sina.com/laruence" target="meme" title="新浪微博"><img src="/images/ico-sina.png" /></a> <a href="http://fusion.google.com/add?feedurl=http://www.laruence.com/feed" target="meme" title="Google阅读器"><img src="/images/ico-google.png" /></a> <a href="mailto:laruence@yahoo.com.cn" target="meme" title="邮件"><img src="/images/ico-mail.png" /></a>)</li>

--><p></p>
                <li>本文地址: <a href="https://www.laruence.com/2012/05/02/2613.html" title="Permanet Link to 让PHP更快的提供文件下载">https://www.laruence.com/2012/05/02/2613.html</a></li>

                <li>转载请注明出处 </li>
            </ul></div>
        <p>
            一般来说, 我们可以通过直接让URL指向一个位于Document Root下面的文件, 来引导用户下载文件.<br>
            但是, 这样做, 就没办法做一些统计, 权限检查, 等等的工作.  于是,  很多时候,  我们采用让PHP来做转发, 为用户提供文件下载.</p>
        <pre name="code" class="sh_php sh_sourceCode" linenum="off"><ol><li><span class="sh_symbol">&lt;?php</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$file</span> <span class="sh_symbol">=</span> <span class="sh_string">"/tmp/dummy.tar.gz"</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-type: application/octet-stream"</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_function">basename</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-Length: "</span><span class="sh_symbol">.</span> <span class="sh_function">filesize</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">))</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">readfile</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span>;</li></ol></pre>
        <p>     但是这个有一个问题, 就是如果文件是中文名的话, 有的用户可能下载后的文件名是乱码.<br>
            于是, 我们做一下修改(参考: :</p>
        <pre name="code" class="sh_php sh_sourceCode" linenum="off"><ol><li><span class="sh_symbol">&lt;?php</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$file</span> <span class="sh_symbol">=</span> <span class="sh_string">"/tmp/中文名.tar.gz"</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$filename</span> <span class="sh_symbol">=</span> <span class="sh_function">basename</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-type: application/octet-stream"</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//处理中文文件名</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$ua</span> <span class="sh_symbol">=</span> <span class="sh_variable">$_SERVER</span><span class="sh_symbol">[</span><span class="sh_string">"HTTP_USER_AGENT"</span><span class="sh_symbol">]</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$encoded_filename</span> <span class="sh_symbol">=</span> <span class="sh_function">rawurlencode</span><span class="sh_symbol">(</span><span class="sh_variable">$filename</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_statement">if</span> <span class="sh_symbol">(</span><span class="sh_function">preg_match</span><span class="sh_symbol">(</span><span class="sh_string">"/MSIE/"</span>, <span class="sh_variable">$ua</span><span class="sh_symbol">))</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_variable">$encoded_filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span> <span class="sh_keyword">else</span> <span class="sh_statement">if</span> <span class="sh_symbol">(</span><span class="sh_function">preg_match</span><span class="sh_symbol">(</span><span class="sh_string">"/Firefox/"</span>, <span class="sh_variable">$ua</span><span class="sh_symbol">))</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-Disposition: attachment; filename*=\"utf8''"</span> <span class="sh_symbol">.</span> <span class="sh_variable">$filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span> <span class="sh_keyword">else</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_variable">$filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-Length: "</span><span class="sh_symbol">.</span> <span class="sh_function">filesize</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">))</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">readfile</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span>;</li></ol></pre>
        <p>    恩, 现在看起来好多了, 不过还有一个问题,  那就是readfile,  虽然PHP的readfile尝试实现的尽量高效, 不占用PHP本身的内存, 但是实际上它还是需要采用MMAP(如果支持), 或者是一个固定的buffer去循环读取文件, 直接输出.<br>
            输出的时候, 如果是Apache + PHP mod, 那么还需要发送到Apache的输出缓冲区. 最后才发送给用户. 而对于Nginx + fpm如果他们分开部署的话, 那还会带来额外的网络IO.<br>
            那么, 能不能不经过PHP这层, 直接让Webserver直接把文件发送给用户呢?<br>
            今天, 我看到了一个有意思的文章: <a href="http://www.jasny.net/articles/how-i-php-x-sendfile/">How I PHP: X-SendFile</a>.<br>
            我们可以使用Apache的module <a href="https://tn123.org/mod_xsendfile/">mod_xsendfile</a>, 让Apache直接发送这个文件给用户:</p>
        <pre name="code" class="sh_php sh_sourceCode" linenum="off"><ol><li><span class="sh_symbol">&lt;?php</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$file</span> <span class="sh_symbol">=</span> <span class="sh_string">"/tmp/中文名.tar.gz"</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$filename</span> <span class="sh_symbol">=</span> <span class="sh_function">basename</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-type: application/octet-stream"</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//处理中文文件名</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$ua</span> <span class="sh_symbol">=</span> <span class="sh_variable">$_SERVER</span><span class="sh_symbol">[</span><span class="sh_string">"HTTP_USER_AGENT"</span><span class="sh_symbol">]</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$encoded_filename</span> <span class="sh_symbol">=</span> <span class="sh_function">rawurlencode</span><span class="sh_symbol">(</span><span class="sh_variable">$filename</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_statement">if</span> <span class="sh_symbol">(</span><span class="sh_function">preg_match</span><span class="sh_symbol">(</span><span class="sh_string">"/MSIE/"</span>, <span class="sh_variable">$ua</span><span class="sh_symbol">))</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_variable">$encoded_filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span> <span class="sh_keyword">else</span> <span class="sh_statement">if</span> <span class="sh_symbol">(</span><span class="sh_function">preg_match</span><span class="sh_symbol">(</span><span class="sh_string">"/Firefox/"</span>, <span class="sh_variable">$ua</span><span class="sh_symbol">))</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-Disposition: attachment; filename*=\"utf8''"</span> <span class="sh_symbol">.</span> <span class="sh_variable">$filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span> <span class="sh_keyword">else</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_variable">$filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//让Xsendfile发送文件</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"X-Sendfile: $file"</span><span class="sh_symbol">)</span>;</li></ol></pre>
        <p>    X-Sendfile头将被Apache处理, 并且把响应的文件直接发送给Client.<br>
            Lighttpd和Nginx也有类似的模块,  大家有兴趣的可以去找找看 <img draggable="false" role="img" class="emoji" alt="🙂" src="https://s.w.org/images/core/emoji/12.0.0-1/svg/1f642.svg"><script type="text/javascript" src="https://www.laruence.com/wp-content/plugins/shjs-syntax-hiliter/shjs/lang/sh_php.js"></script></p>
    </div>
    <div class="post-meta">
        <div class="post-categories"><span>Filed in </span><a href="https://www.laruence.com/category/php-usage" title="View all posts in PHP应用">PHP应用</a></div>				<div class="post-tags"><ul><li><a href="https://www.laruence.com/tag/php" title="View all posts tagged PHP">PHP</a></li><li><a href="https://www.laruence.com/tag/xsendfile" title="View all posts tagged Xsendfile">Xsendfile</a></li><li><a href="https://www.laruence.com/tag/%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6" title="View all posts tagged 下载文件">下载文件</a></li><li><a href="https://www.laruence.com/tag/%e4%b8%ad%e6%96%87%e6%96%87%e4%bb%b6%e5%90%8d" title="View all posts tagged 中文文件名">中文文件名</a></li></ul></div>				<nav class="further-reading">
        <div class="previous">
            <span>Previous Post</span>
            <a href="https://www.laruence.com/2012/04/30/2594.html" rel="prev">如何为PHP贡献代码</a>	</div>
        <div class="next">
            <span>Next Post</span>
            <a href="https://www.laruence.com/2012/06/14/2628.html" rel="next">PHP的Calling Scope</a>	</div>
    </nav>			</div>
</div>