<article id="post-150" class="single-post post-150 post type-post status-publish format-standard has-post-thumbnail hentry category-study">
    <h1 class="entry-title">编译升级PHP 7.4.0</h1>
    <div class="post-meta">
	<span class="vcard author">
		<a href="https://hqidi.com/author/huangqidi" class="vcard author" rel="author">dige</a></span>
        <span class="divider">•</span>
        <time class="entry-date published" datetime="2019-11-29T14:50:12+08:00">2019年11月29日</time>
        <span class="divider">•</span>
        <span class="comments-count"><a href="https://hqidi.com/150.html#comments">11 条评论</a></span>
        <span class="divider">•</span>
        9,129 人阅读	</div>
    <!-- END .post-meta -->
    <!-- END .entry-header -->
    <div class="entry-content">
        <h3>备份当前版本</h3>
        <p>安全第一，不忘备份</p>
        <div class="precode clearfix"><pre class="prettyprint prettyprinted" style=""><span class="pln">which php
</span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">php</span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">php
cp </span><span class="pun">-</span><span class="pln">r </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">php </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">php_bak</span></pre></div>
        <h3>获取当前 PHP 配置参数</h3>
        <p>我是直接在历史命令里面找到的：<br>
            history |grep configure<br>
            如果你找不到就执行如下命令找：</p>
        <p>/usr/local/php/bin/php -i | head</p>
        <p>总之，我们需要的就是下面的东西：</p>
        <p>./configure --prefix=/usr/local/php --enable-opcache --with-config-file-path=/usr/local/php/etc --with-curl --enable-fpm  --with-gd --with-iconv --enable-mbstring --with-mysqli=mysqlnd --with-openssl --enable-static --enable-sockets --enable-inline-optimization --with-zlib --disable-ipv6 --disable-fileinfo --disable-debug</p>
        <p>这里要注意，气死你的PHP版本里面(7.4.0)<span style="color: #ff0000;">已经不支持“--with-gd”，得改成“--enable-gd”</span>，否则会报错“GD Library Error: imagecreatetruecolor does not exist - please contact your webhost and ask them to install the GD library<br>
            ”所以最终我们得到的配置参数为：</p>
        <p>./configure --prefix=/usr/local/php --enable-opcache --with-config-file-path=/usr/local/php/etc --with-curl --enable-fpm  --enable-gd --with-iconv --enable-mbstring --with-mysqli=mysqlnd --with-openssl --enable-static --enable-sockets --enable-inline-optimization --with-zlib --disable-ipv6 --disable-fileinfo --disable-debug</p>
        <h3>下载PHP</h3>
        <p>从 https://www.php.net/downloads.php 页面下载 PHP 的最新 Stable 版本，解压缩，进入源码目录。</p>
        <div class="precode clearfix"><pre class="prettyprint prettyprinted" style=""><span class="pln">wget https</span><span class="pun">:</span><span class="com">//www.php.net/distributions/php-7.4.0.tar.gz</span><span class="pln">
tar xf php</span><span class="pun">-</span><span class="lit">7.4</span><span class="pun">.</span><span class="lit">0.tar</span><span class="pun">.</span><span class="pln">gz
cd php</span><span class="pun">-</span><span class="lit">7.4</span><span class="pun">.</span><span class="lit">0</span></pre></div>
        <h3>配置PHP</h3>
        <p>在编译之前，需要进入源代码目录，对要安装的程序进行各种参数配置，比如安装到什么地方，需要开启哪些功能等。配置工作一般都由源码目录中的configure脚本完成。</p>
        <div class="precode clearfix"><pre class="prettyprint prettyprinted" style=""><span class="pun">.</span><span class="str">/configure --prefix=/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">php </span><span class="pun">--</span><span class="pln">enable</span><span class="pun">-</span><span class="pln">opcache </span><span class="pun">--</span><span class="kwd">with</span><span class="pun">-</span><span class="pln">config</span><span class="pun">-</span><span class="pln">file</span><span class="pun">-</span><span class="pln">path</span><span class="pun">=</span><span class="str">/usr/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">php</span><span class="pun">/</span><span class="pln">etc </span><span class="pun">--</span><span class="kwd">with</span><span class="pun">-</span><span class="pln">curl </span><span class="pun">--</span><span class="pln">enable</span><span class="pun">-</span><span class="pln">fpm  </span><span class="pun">--</span><span class="pln">enable</span><span class="pun">-</span><span class="pln">gd </span><span class="pun">--</span><span class="kwd">with</span><span class="pun">-</span><span class="pln">iconv </span><span class="pun">--</span><span class="pln">enable</span><span class="pun">-</span><span class="pln">mbstring </span><span class="pun">--</span><span class="kwd">with</span><span class="pun">-</span><span class="pln">mysqli</span><span class="pun">=</span><span class="pln">mysqlnd </span><span class="pun">--</span><span class="kwd">with</span><span class="pun">-</span><span class="pln">openssl </span><span class="pun">--</span><span class="pln">enable</span><span class="pun">-</span><span class="kwd">static</span><span class="pln"> </span><span class="pun">--</span><span class="pln">enable</span><span class="pun">-</span><span class="pln">sockets </span><span class="pun">--</span><span class="pln">enable</span><span class="pun">-</span><span class="kwd">inline</span><span class="pun">-</span><span class="pln">optimization </span><span class="pun">--</span><span class="kwd">with</span><span class="pun">-</span><span class="pln">zlib </span><span class="pun">--</span><span class="pln">disable</span><span class="pun">-</span><span class="pln">ipv6 </span><span class="pun">--</span><span class="pln">disable</span><span class="pun">-</span><span class="pln">fileinfo </span><span class="pun">--</span><span class="pln">disable</span><span class="pun">-</span><span class="pln">debug</span></pre></div>
        <h4>error: Package requirements (sqlite3 &gt; 3.7.4) were not met</h4>
        <p>error: Package requirements (sqlite3 &gt; 3.7.4) were not met<br>
            No package 'sqlite3' found<br>
            若看到上面的报错，非常简单：<br>
            yum install libsqlite3x-devel -y</p>
        <h4>error: Package requirements (oniguruma) were not met</h4>
        <p>error: Package requirements (oniguruma) were not met<br>
            No package 'oniguruma' found<br>
            若看到上面的报错，非常简单：<br>
            yum install oniguruma-devel -y</p>
        <h3>编译PHP</h3>
        <p>刚才的配置通过后，直接运行 make 进行编译。</p>
        <h3>安装PHP</h3>
        <p>刚才的编译通过后，先停止PHP-FPM服务：<br>
            systemctl stop php-fpm<br>
            然后运行 make install 进行安装，安装成功后，我们得改下php.ini文件，该文件里面的<br>
            zend_extension="/usr/local/php/lib/php/extensions/no-debug-non-zts-20170718/opcache.so"<br>
            改成：<br>
            zend_extension="/usr/local/php/lib/php/extensions/no-debug-non-zts-20190902/opcache.so"<br>
            最后启动PHP-FPM服务：<br>
            systemctl start php-fpm<br>
            进入你的网站根目录执行：<br>
            echo "&lt;?php phpinfo() ?&gt;" &gt;d.php<br>
            然后访问 https://yoursite.com/d.php 来检测此处升级的结果，确认升级成功后记得删除 d.php</p>
        <p>更详细的安装步骤请查看：<br>
            <a href="https://hqidi.com/51.html" rel="noopener" target="_blank">Centos 6.5 x64安装php 7.2</a><br>
            <a href="https://hqidi.com/129.html" rel="noopener" target="_blank">PHP-FPM没有生成socket文件</a></p>
        <div style="margin-top: 15px; font-style: italic">
            <p><strong>原创文章，转载请注明：</strong> 转载自<a href="https://hqidi.com/">笛声</a></p>
            <p><strong>本文链接地址:</strong> <a href="https://hqidi.com/150.html">编译升级PHP 7.4.0</a></p>
        </div>
    </div>
    <!-- END .entry-content -->
    <footer class="entry-footer">
    </footer>
    <!-- END .entry-footer -->
</article>