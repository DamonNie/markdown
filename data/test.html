<div class="post-container">
    <div class="post-header">
        <h1 class="post-title">è®©PHPæ›´å¿«çš„æä¾›æ–‡ä»¶ä¸‹è½½</h1>
        <div class="post-byline">Published on <a class="date" href="https://www.laruence.com/2012/05">2 May 2012</a> by <a class="author" href="https://www.laruence.com/author/laruence">laruence</a></div>			</div>
    <div class="post-content">

        <div class="copyright">
            <ul>
                <!--

<li>ä½œè€…: <a href="https://www.laruence.com">Laruence</a>(<a href="http://www.twitter.com/laruence" target="meme" title="Twitter"><img src="/images/ico-twitter.png" /></a> <a href="http://t.sina.com/laruence" target="meme" title="æ–°æµªå¾®åš"><img src="/images/ico-sina.png" /></a> <a href="http://fusion.google.com/add?feedurl=http://www.laruence.com/feed" target="meme" title="Googleé˜…è¯»å™¨"><img src="/images/ico-google.png" /></a> <a href="mailto:laruence@yahoo.com.cn" target="meme" title="é‚®ä»¶"><img src="/images/ico-mail.png" /></a>)</li>

--><p></p>
                <li>æœ¬æ–‡åœ°å€: <a href="https://www.laruence.com/2012/05/02/2613.html" title="Permanet Link to è®©PHPæ›´å¿«çš„æä¾›æ–‡ä»¶ä¸‹è½½">https://www.laruence.com/2012/05/02/2613.html</a></li>

                <li>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ </li>
            </ul></div>
        <p>
            ä¸€èˆ¬æ¥è¯´, æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥è®©URLæŒ‡å‘ä¸€ä¸ªä½äºDocument Rootä¸‹é¢çš„æ–‡ä»¶, æ¥å¼•å¯¼ç”¨æˆ·ä¸‹è½½æ–‡ä»¶.<br>
            ä½†æ˜¯, è¿™æ ·åš, å°±æ²¡åŠæ³•åšä¸€äº›ç»Ÿè®¡, æƒé™æ£€æŸ¥, ç­‰ç­‰çš„å·¥ä½œ.  äºæ˜¯,  å¾ˆå¤šæ—¶å€™,  æˆ‘ä»¬é‡‡ç”¨è®©PHPæ¥åšè½¬å‘, ä¸ºç”¨æˆ·æä¾›æ–‡ä»¶ä¸‹è½½.</p>
        <pre name="code" class="sh_php sh_sourceCode" linenum="off"><ol><li><span class="sh_symbol">&lt;?php</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$file</span> <span class="sh_symbol">=</span> <span class="sh_string">"/tmp/dummy.tar.gz"</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-type: application/octet-stream"</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_function">basename</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-Length: "</span><span class="sh_symbol">.</span> <span class="sh_function">filesize</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">))</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">readfile</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span>;</li></ol></pre>
        <p>     ä½†æ˜¯è¿™ä¸ªæœ‰ä¸€ä¸ªé—®é¢˜, å°±æ˜¯å¦‚æœæ–‡ä»¶æ˜¯ä¸­æ–‡åçš„è¯, æœ‰çš„ç”¨æˆ·å¯èƒ½ä¸‹è½½åçš„æ–‡ä»¶åæ˜¯ä¹±ç .<br>
            äºæ˜¯, æˆ‘ä»¬åšä¸€ä¸‹ä¿®æ”¹(å‚è€ƒ: :</p>
        <pre name="code" class="sh_php sh_sourceCode" linenum="off"><ol><li><span class="sh_symbol">&lt;?php</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$file</span> <span class="sh_symbol">=</span> <span class="sh_string">"/tmp/ä¸­æ–‡å.tar.gz"</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$filename</span> <span class="sh_symbol">=</span> <span class="sh_function">basename</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-type: application/octet-stream"</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//å¤„ç†ä¸­æ–‡æ–‡ä»¶å</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$ua</span> <span class="sh_symbol">=</span> <span class="sh_variable">$_SERVER</span><span class="sh_symbol">[</span><span class="sh_string">"HTTP_USER_AGENT"</span><span class="sh_symbol">]</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$encoded_filename</span> <span class="sh_symbol">=</span> <span class="sh_function">rawurlencode</span><span class="sh_symbol">(</span><span class="sh_variable">$filename</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_statement">if</span> <span class="sh_symbol">(</span><span class="sh_function">preg_match</span><span class="sh_symbol">(</span><span class="sh_string">"/MSIE/"</span>, <span class="sh_variable">$ua</span><span class="sh_symbol">))</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_variable">$encoded_filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span> <span class="sh_keyword">else</span> <span class="sh_statement">if</span> <span class="sh_symbol">(</span><span class="sh_function">preg_match</span><span class="sh_symbol">(</span><span class="sh_string">"/Firefox/"</span>, <span class="sh_variable">$ua</span><span class="sh_symbol">))</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-Disposition: attachment; filename*=\"utf8''"</span> <span class="sh_symbol">.</span> <span class="sh_variable">$filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span> <span class="sh_keyword">else</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_variable">$filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-Length: "</span><span class="sh_symbol">.</span> <span class="sh_function">filesize</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">))</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">readfile</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span>;</li></ol></pre>
        <p>    æ©, ç°åœ¨çœ‹èµ·æ¥å¥½å¤šäº†, ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªé—®é¢˜,  é‚£å°±æ˜¯readfile,  è™½ç„¶PHPçš„readfileå°è¯•å®ç°çš„å°½é‡é«˜æ•ˆ, ä¸å ç”¨PHPæœ¬èº«çš„å†…å­˜, ä½†æ˜¯å®é™…ä¸Šå®ƒè¿˜æ˜¯éœ€è¦é‡‡ç”¨MMAP(å¦‚æœæ”¯æŒ), æˆ–è€…æ˜¯ä¸€ä¸ªå›ºå®šçš„bufferå»å¾ªç¯è¯»å–æ–‡ä»¶, ç›´æ¥è¾“å‡º.<br>
            è¾“å‡ºçš„æ—¶å€™, å¦‚æœæ˜¯Apache + PHP mod, é‚£ä¹ˆè¿˜éœ€è¦å‘é€åˆ°Apacheçš„è¾“å‡ºç¼“å†²åŒº. æœ€åæ‰å‘é€ç»™ç”¨æˆ·. è€Œå¯¹äºNginx + fpmå¦‚æœä»–ä»¬åˆ†å¼€éƒ¨ç½²çš„è¯, é‚£è¿˜ä¼šå¸¦æ¥é¢å¤–çš„ç½‘ç»œIO.<br>
            é‚£ä¹ˆ, èƒ½ä¸èƒ½ä¸ç»è¿‡PHPè¿™å±‚, ç›´æ¥è®©Webserverç›´æ¥æŠŠæ–‡ä»¶å‘é€ç»™ç”¨æˆ·å‘¢?<br>
            ä»Šå¤©, æˆ‘çœ‹åˆ°äº†ä¸€ä¸ªæœ‰æ„æ€çš„æ–‡ç« : <a href="http://www.jasny.net/articles/how-i-php-x-sendfile/">How I PHP: X-SendFile</a>.<br>
            æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Apacheçš„module <a href="https://tn123.org/mod_xsendfile/">mod_xsendfile</a>, è®©Apacheç›´æ¥å‘é€è¿™ä¸ªæ–‡ä»¶ç»™ç”¨æˆ·:</p>
        <pre name="code" class="sh_php sh_sourceCode" linenum="off"><ol><li><span class="sh_symbol">&lt;?php</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$file</span> <span class="sh_symbol">=</span> <span class="sh_string">"/tmp/ä¸­æ–‡å.tar.gz"</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$filename</span> <span class="sh_symbol">=</span> <span class="sh_function">basename</span><span class="sh_symbol">(</span><span class="sh_variable">$file</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-type: application/octet-stream"</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//å¤„ç†ä¸­æ–‡æ–‡ä»¶å</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$ua</span> <span class="sh_symbol">=</span> <span class="sh_variable">$_SERVER</span><span class="sh_symbol">[</span><span class="sh_string">"HTTP_USER_AGENT"</span><span class="sh_symbol">]</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_variable">$encoded_filename</span> <span class="sh_symbol">=</span> <span class="sh_function">rawurlencode</span><span class="sh_symbol">(</span><span class="sh_variable">$filename</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_statement">if</span> <span class="sh_symbol">(</span><span class="sh_function">preg_match</span><span class="sh_symbol">(</span><span class="sh_string">"/MSIE/"</span>, <span class="sh_variable">$ua</span><span class="sh_symbol">))</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_variable">$encoded_filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span> <span class="sh_keyword">else</span> <span class="sh_statement">if</span> <span class="sh_symbol">(</span><span class="sh_function">preg_match</span><span class="sh_symbol">(</span><span class="sh_string">"/Firefox/"</span>, <span class="sh_variable">$ua</span><span class="sh_symbol">))</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"Content-Disposition: attachment; filename*=\"utf8''"</span> <span class="sh_symbol">.</span> <span class="sh_variable">$filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span> <span class="sh_keyword">else</span> <span class="sh_symbol">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">'Content-Disposition: attachment; filename="'</span> <span class="sh_symbol">.</span> <span class="sh_variable">$filename</span> <span class="sh_symbol">.</span> <span class="sh_string">'"'</span><span class="sh_symbol">)</span>;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">}</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//è®©Xsendfileå‘é€æ–‡ä»¶</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_function">header</span><span class="sh_symbol">(</span><span class="sh_string">"X-Sendfile: $file"</span><span class="sh_symbol">)</span>;</li></ol></pre>
        <p>    X-Sendfileå¤´å°†è¢«Apacheå¤„ç†, å¹¶ä¸”æŠŠå“åº”çš„æ–‡ä»¶ç›´æ¥å‘é€ç»™Client.<br>
            Lighttpdå’ŒNginxä¹Ÿæœ‰ç±»ä¼¼çš„æ¨¡å—,  å¤§å®¶æœ‰å…´è¶£çš„å¯ä»¥å»æ‰¾æ‰¾çœ‹ <img draggable="false" role="img" class="emoji" alt="ğŸ™‚" src="https://s.w.org/images/core/emoji/12.0.0-1/svg/1f642.svg"><script type="text/javascript" src="https://www.laruence.com/wp-content/plugins/shjs-syntax-hiliter/shjs/lang/sh_php.js"></script></p>
    </div>
    <div class="post-meta">
        <div class="post-categories"><span>Filed in </span><a href="https://www.laruence.com/category/php-usage" title="View all posts in PHPåº”ç”¨">PHPåº”ç”¨</a></div>				<div class="post-tags"><ul><li><a href="https://www.laruence.com/tag/php" title="View all posts tagged PHP">PHP</a></li><li><a href="https://www.laruence.com/tag/xsendfile" title="View all posts tagged Xsendfile">Xsendfile</a></li><li><a href="https://www.laruence.com/tag/%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6" title="View all posts tagged ä¸‹è½½æ–‡ä»¶">ä¸‹è½½æ–‡ä»¶</a></li><li><a href="https://www.laruence.com/tag/%e4%b8%ad%e6%96%87%e6%96%87%e4%bb%b6%e5%90%8d" title="View all posts tagged ä¸­æ–‡æ–‡ä»¶å">ä¸­æ–‡æ–‡ä»¶å</a></li></ul></div>				<nav class="further-reading">
        <div class="previous">
            <span>Previous Post</span>
            <a href="https://www.laruence.com/2012/04/30/2594.html" rel="prev">å¦‚ä½•ä¸ºPHPè´¡çŒ®ä»£ç </a>	</div>
        <div class="next">
            <span>Next Post</span>
            <a href="https://www.laruence.com/2012/06/14/2628.html" rel="next">PHPçš„Calling Scope</a>	</div>
    </nav>			</div>
</div>