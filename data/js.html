<article data-v-0526462d="" itemscope="itemscope" itemtype="http://schema.org/Article" class="article" data-v-0591b948=""><meta itemprop="url" content="https://juejin.im/post/5aa1395c6fb9a028df223516"><meta itemprop="headline" content="JS中浮点数精度问题"><meta itemprop="keywords" content="Chrome,JavaScript,前端,单元测试"><meta itemprop="datePublished" content="2018-03-08T13:26:00.956Z"><meta itemprop="image" content="https://b-gold-cdn.xitu.io/icon/icon-128.png"><div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谢小飞"><meta itemprop="url" content="https://juejin.im/user/580038cebf22ec0064bd0b2d"></div><div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"><div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://b-gold-cdn.xitu.io/icon/icon-white-180.png"><meta itemprop="width" content="180"><meta itemprop="height" content="180"></div></div><div data-v-0526462d="" class="author-info-block"><a data-v-0526462d="" href="/user/580038cebf22ec0064bd0b2d" target="_blank" rel="" class="avatar-link"><div data-v-10f5e1e2="" data-v-762a6aba="" data-v-0526462d="" data-src="https://user-gold-cdn.xitu.io/2017/12/9/1603b5820ac466ee?imageView2/1/w/100/h/100/q/85/format/webp/interlace/1" class="lazy avatar avatar loaded" style="background-image: url(&quot;https://user-gold-cdn.xitu.io/2017/12/9/1603b5820ac466ee?imageView2/1/w/100/h/100/q/85/format/webp/interlace/1&quot;);"></div></a><div data-v-0526462d="" class="author-info-box"><a data-v-db47c888="" data-v-0526462d="" href="/user/580038cebf22ec0064bd0b2d" target="_blank" rel="" class="username username ellipsis">谢小飞<a data-v-0ba9b815="" data-v-db47c888="" href="/book/5c90640c5188252d7941f5bb/section/5c9065385188252da6320022" target="_blank" rel="" class="rank"><img data-v-0ba9b815="" src="https://b-gold-cdn.xitu.io/v3/static/img/lv-3.e108c68.svg" alt="lv-3"></a></a><div data-v-0526462d="" class="meta-box"><time data-v-0526462d="" datetime="2018-03-08T13:26:00.956Z" title="Thu Mar 08 2018 21:26:00 GMT+0800 (中国标准时间)" class="time">2018年03月08日</time><span data-v-0526462d="" class="views-count">阅读 8150</span><!----></div></div><button data-v-0bccdb0e="" data-v-0526462d="" class="follow-button follow">关注</button></div><!----><h1 data-v-0526462d="" class="article-title">JS中浮点数精度问题</h1><div data-v-0526462d="" data-id="5aa139e8518825558a062e8a" itemprop="articleBody" class="article-content"><p>  最近在做项目的时候，涉及到商品价格的计算，经常会出现计算出现精度问题。刚开始草草了事，直接用toFixed就解决了问题，并没有好好的思考一下这个问题。后来慢慢的，问题越来越多，连toFixed也出现了（允悲），后来经过搜索网上的各种博客和论坛，整理总结了一下。</p>
<h1 class="heading" data-id="heading-0">问题的发现</h1>
<p>  总结了一下，一共有以下两种问题</p>
<h2 class="heading" data-id="heading-1">浮点数运算后的精度问题</h2>
<p>  在计算商品价格加减乘除时，偶尔## 会出现精度问题，一些常见的例子如下：</p>
<pre><code class="hljs javascript copyable" lang="javascript"><span class="hljs-comment">// 加法 =====================</span>
<span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span> = <span class="hljs-number">0.30000000000000004</span>
<span class="hljs-number">0.7</span> + <span class="hljs-number">0.1</span> = <span class="hljs-number">0.7999999999999999</span>
<span class="hljs-number">0.2</span> + <span class="hljs-number">0.4</span> = <span class="hljs-number">0.6000000000000001</span>

<span class="hljs-comment">// 减法 =====================</span>
<span class="hljs-number">1.5</span> - <span class="hljs-number">1.2</span> = <span class="hljs-number">0.30000000000000004</span>
<span class="hljs-number">0.3</span> - <span class="hljs-number">0.2</span> = <span class="hljs-number">0.09999999999999998</span>
 
<span class="hljs-comment">// 乘法 =====================</span>
<span class="hljs-number">19.9</span> * <span class="hljs-number">100</span> = <span class="hljs-number">1989.9999999999998</span>
<span class="hljs-number">0.8</span> * <span class="hljs-number">3</span> = <span class="hljs-number">2.4000000000000004</span>
<span class="hljs-number">35.41</span> * <span class="hljs-number">100</span> = <span class="hljs-number">3540.9999999999995</span>

<span class="hljs-comment">// 除法 =====================</span>
<span class="hljs-number">0.3</span> / <span class="hljs-number">0.1</span> = <span class="hljs-number">2.9999999999999996</span>
<span class="hljs-number">0.69</span> / <span class="hljs-number">10</span> = <span class="hljs-number">0.06899999999999999</span>
<span class="copy-code-btn">复制代码</span></code></pre><h2 class="heading" data-id="heading-2">toFixed奇葩问题</h2>
<p>  在遇到浮点数运算后出现的精度问题时，刚开始我是使用toFixed(2)来解决的，因为在W3school和菜鸟教程（他们均表示这锅不背）上明确写着定义：toFixed()方法可把Number四舍五入为指定小数位数的数字。</p>
<p>  但是在chrome下测试结果不太令人满意：</p>
<pre><code class="hljs javascript copyable" lang="javascript"><span class="hljs-number">1.35</span>.toFixed(<span class="hljs-number">1</span>) <span class="hljs-comment">// 1.4 正确</span>
<span class="hljs-number">1.335</span>.toFixed(<span class="hljs-number">2</span>) <span class="hljs-comment">// 1.33  错误</span>
<span class="hljs-number">1.3335</span>.toFixed(<span class="hljs-number">3</span>) <span class="hljs-comment">// 1.333 错误</span>
<span class="hljs-number">1.33335</span>.toFixed(<span class="hljs-number">4</span>) <span class="hljs-comment">// 1.3334 正确</span>
<span class="hljs-number">1.333335</span>.toFixed(<span class="hljs-number">5</span>)  <span class="hljs-comment">// 1.33333 错误</span>
<span class="hljs-number">1.3333335</span>.toFixed(<span class="hljs-number">6</span>) <span class="hljs-comment">// 1.333333 错误</span>
<span class="copy-code-btn">复制代码</span></code></pre><p>  使用IETester在IE下面测试的结果却是正确的。</p>
<h1 class="heading" data-id="heading-3">为什么会产生</h1>
<p>  让我们来看一下为什么0.1+0.2会等于0.30000000000000004，而不是0.3。首先，想要知道为什么会产生这样的问题，让我们回到大学里学的复（ku）杂（zao）的计算机组成原理。虽然已经全部还给大学老师了，但是没关系，我们还有百度嘛。</p>
<h2 class="heading" data-id="heading-4">浮点数的存储</h2>
<p>  和其它语言如Java和Python不同，JavaScript中所有数字包括整数和小数都只有一种类型 — Number。它的实现遵循 IEEE 754 标准，使用64位固定长度来表示，也就是标准的 double 双精度浮点数（相关的还有float 32位单精度）。</p>
<p>  这样的存储结构优点是可以归一化处理整数和小数，节省存储空间。</p>
<p>  64位比特又可分为三个部分：</p>
<ul>
<li>
<p>符号位S：第 1 位是正负数符号位（sign），0代表正数，1代表负数</p>
</li>
<li>
<p>指数位E：中间的 11 位存储指数（exponent），用来表示次方数</p>
</li>
<li>
<p>尾数位M：最后的 52 位是尾数（mantissa），超出的部分自动进一舍零</p>
</li>
</ul>
<p></p><figure><img alt="Storage" class="lazyload inited loaded" data-src="https://user-gold-cdn.xitu.io/2018/3/8/16205c88ea806bac?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-width="594" data-height="96" src="https://user-gold-cdn.xitu.io/2018/3/8/16205c88ea806bac?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><figcaption></figcaption></figure><p></p>
<h2 class="heading" data-id="heading-5">浮点数的运算</h2>
<p>  那么JavaScript在计算0.1+0.2时到底发生了什么呢？</p>
<p>  首先，十进制的0.1和0.2会被转换成二进制的，但是由于浮点数用二进制表示时是无穷的：</p>
<pre><code class="hljs javascript copyable" lang="javascript"><span class="hljs-number">0.1</span> -&gt; <span class="hljs-number">0.0001</span> <span class="hljs-number">1001</span> <span class="hljs-number">1001</span> <span class="hljs-number">1001.</span>..(<span class="hljs-number">1100</span>循环)
<span class="hljs-number">0.2</span> -&gt; <span class="hljs-number">0.0011</span> <span class="hljs-number">0011</span> <span class="hljs-number">0011</span> <span class="hljs-number">0011.</span>..(<span class="hljs-number">0011</span>循环)
<span class="copy-code-btn">复制代码</span></code></pre><p>  IEEE 754 标准的 64 位双精度浮点数的小数部分最多支持53位二进制位，所以两者相加之后得到二进制为：</p>
<pre><code class="hljs javascript copyable" lang="javascript"><span class="hljs-number">0.0100110011001100110011001100110011001100110011001100</span> 
<span class="copy-code-btn">复制代码</span></code></pre><p>  因浮点数小数位的限制而截断的二进制数字，再转换为十进制，就成了0.30000000000000004。所以在进行算术计算时会产生误差。</p>
<h1 class="heading" data-id="heading-6">解决方法</h1>
<p>  针对以上两个问题，网上搜了一波解决方法，基本都大同小异的，分别来看一下。</p>
<h2 class="heading" data-id="heading-7">解决toFixed</h2>
<p>  针对toFixed的兼容性问题，我们可以把toFix重写一下来解决，代码如下：</p>
<pre><code class="hljs javascript copyable" lang="javascript"><span class="hljs-comment">// toFixed兼容方法</span>
<span class="hljs-built_in">Number</span>.prototype.toFixed = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">len</span>)</span>{
    <span class="hljs-keyword">if</span>(len&gt;<span class="hljs-number">20</span> || len&lt;<span class="hljs-number">0</span>){
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RangeError</span>(<span class="hljs-string">'toFixed() digits argument must be between 0 and 20'</span>);
    }
    <span class="hljs-comment">// .123转为0.123</span>
    <span class="hljs-keyword">var</span> number = <span class="hljs-built_in">Number</span>(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(number) || number &gt;= <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, <span class="hljs-number">21</span>)) {
        <span class="hljs-keyword">return</span> number.toString();
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (len) == <span class="hljs-string">'undefined'</span> || len == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">Math</span>.round(number)).toString();
    }
    <span class="hljs-keyword">var</span> result = number.toString(),
        numberArr = result.split(<span class="hljs-string">'.'</span>);

    <span class="hljs-keyword">if</span>(numberArr.length&lt;<span class="hljs-number">2</span>){
        <span class="hljs-comment">//整数的情况</span>
        <span class="hljs-keyword">return</span> padNum(result);
    }
    <span class="hljs-keyword">var</span> intNum = numberArr[<span class="hljs-number">0</span>], <span class="hljs-comment">//整数部分</span>
        deciNum = numberArr[<span class="hljs-number">1</span>],<span class="hljs-comment">//小数部分</span>
        lastNum = deciNum.substr(len, <span class="hljs-number">1</span>);<span class="hljs-comment">//最后一个数字</span>
    
    <span class="hljs-keyword">if</span>(deciNum.length == len){
        <span class="hljs-comment">//需要截取的长度等于当前长度</span>
        <span class="hljs-keyword">return</span> result;
    }
    <span class="hljs-keyword">if</span>(deciNum.length &lt; len){
        <span class="hljs-comment">//需要截取的长度大于当前长度 1.3.toFixed(2)</span>
        <span class="hljs-keyword">return</span> padNum(result)
    }
    <span class="hljs-comment">//需要截取的长度小于当前长度，需要判断最后一位数字</span>
    result = intNum + <span class="hljs-string">'.'</span> + deciNum.substr(<span class="hljs-number">0</span>, len);
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">parseInt</span>(lastNum, <span class="hljs-number">10</span>)&gt;=<span class="hljs-number">5</span>){
        <span class="hljs-comment">//最后一位数字大于5，要进位</span>
        <span class="hljs-keyword">var</span> times = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, len); <span class="hljs-comment">//需要放大的倍数</span>
        <span class="hljs-keyword">var</span> changedInt = <span class="hljs-built_in">Number</span>(result.replace(<span class="hljs-string">'.'</span>,<span class="hljs-string">''</span>));<span class="hljs-comment">//截取后转为整数</span>
        changedInt++;<span class="hljs-comment">//整数进位</span>
        changedInt /= times;<span class="hljs-comment">//整数转为小数，注：有可能还是整数</span>
        result = padNum(changedInt+<span class="hljs-string">''</span>);
    }
    <span class="hljs-keyword">return</span> result;
    <span class="hljs-comment">//对数字末尾加0</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">padNum</span>(<span class="hljs-params">num</span>)</span>{
        <span class="hljs-keyword">var</span> dotPos = num.indexOf(<span class="hljs-string">'.'</span>);
        <span class="hljs-keyword">if</span>(dotPos === <span class="hljs-number">-1</span>){
            <span class="hljs-comment">//整数的情况</span>
            num += <span class="hljs-string">'.'</span>;
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;i&lt;len;i++){
                num += <span class="hljs-string">'0'</span>;
            }
            <span class="hljs-keyword">return</span> num;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//小数的情况</span>
            <span class="hljs-keyword">var</span> need = len - (num.length - dotPos - <span class="hljs-number">1</span>);
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>;j&lt;need;j++){
                num += <span class="hljs-string">'0'</span>;
            }
            <span class="hljs-keyword">return</span> num;
        }
    }
}
<span class="copy-code-btn">复制代码</span></code></pre><p>  我们通过判断最后一位是否大于等于5来决定需不需要进位，如果需要进位先把小数乘以倍数变为整数，加1之后，再除以倍数变为小数，这样就不用一位一位的进行判断。</p>
<h2 class="heading" data-id="heading-8">解决浮点数运算精度</h2>
<p>  既然我们发现了浮点数的这个问题，又不能直接让两个浮点数运算，那怎么处理呢？</p>
<p>  我们可以把需要计算的数字升级（乘以10的n次幂）成计算机能够精确识别的整数，等计算完成后再进行降级（除以10的n次幂），这是大部分变成语言处理精度问题常用的方法。例如：</p>
<pre><code class="hljs javascript copyable" lang="javascript"><span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span> == <span class="hljs-number">0.3</span> <span class="hljs-comment">//false</span>
(<span class="hljs-number">0.1</span>*<span class="hljs-number">10</span> + <span class="hljs-number">0.2</span>*<span class="hljs-number">10</span>)/<span class="hljs-number">10</span> == <span class="hljs-number">0.3</span> <span class="hljs-comment">//true</span>
<span class="copy-code-btn">复制代码</span></code></pre><p>  但是这样就能完美解决么？细心的读者可能在上面的例子里已经发现了问题：</p>
<pre><code class="hljs javascript copyable" lang="javascript"><span class="hljs-number">35.41</span> * <span class="hljs-number">100</span> = <span class="hljs-number">3540.9999999999995</span>
<span class="copy-code-btn">复制代码</span></code></pre><p>  看来进行数字升级也不是完全的可靠啊（允悲）。</p>
<p>  但是魔高一尺道高一丈，这样就能难住我们么，我们可以将浮点数toString后indexOf('.')，记录一下小数位的长度，然后将小数点抹掉，完整的代码如下：</p>
<pre><code class="hljs javascript copyable" lang="javascript"> <span class="hljs-comment">/*** method **
 *  add / subtract / multiply /divide
 * floatObj.add(0.1, 0.2) &gt;&gt; 0.3
 * floatObj.multiply(19.9, 100) &gt;&gt; 1990
 *
 */</span>
<span class="hljs-keyword">var</span> floatObj = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-comment">/*
     * 判断obj是否为一个整数
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isInteger</span>(<span class="hljs-params">obj</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor(obj) === obj
    }

    <span class="hljs-comment">/*
     * 将一个浮点数转成整数，返回整数和倍数。如 3.14 &gt;&gt; 314，倍数是 100
     * @param floatNum {number} 小数
     * @return {object}
     *   {times:100, num: 314}
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toInteger</span>(<span class="hljs-params">floatNum</span>) </span>{
        <span class="hljs-keyword">var</span> ret = {<span class="hljs-attr">times</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">0</span>}
        <span class="hljs-keyword">if</span> (isInteger(floatNum)) {
            ret.num = floatNum
            <span class="hljs-keyword">return</span> ret
        }
        <span class="hljs-keyword">var</span> strfi  = floatNum + <span class="hljs-string">''</span>
        <span class="hljs-keyword">var</span> dotPos = strfi.indexOf(<span class="hljs-string">'.'</span>)
        <span class="hljs-keyword">var</span> len    = strfi.substr(dotPos+<span class="hljs-number">1</span>).length
        <span class="hljs-keyword">var</span> times  = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, len)
        <span class="hljs-keyword">var</span> intNum = <span class="hljs-built_in">Number</span>(floatNum.toString().replace(<span class="hljs-string">'.'</span>,<span class="hljs-string">''</span>))
        ret.times  = times
        ret.num    = intNum
        <span class="hljs-keyword">return</span> ret
    }

    <span class="hljs-comment">/*
     * 核心方法，实现加减乘除运算，确保不丢失精度
     * 思路：把小数放大为整数（乘），进行算术运算，再缩小为小数（除）
     *
     * @param a {number} 运算数1
     * @param b {number} 运算数2
     * @param digits {number} 精度，保留的小数点数，比如 2, 即保留为两位小数
     * @param op {string} 运算类型，有加减乘除（add/subtract/multiply/divide）
     *
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">operation</span>(<span class="hljs-params">a, b, digits, op</span>) </span>{
        <span class="hljs-keyword">var</span> o1 = toInteger(a)
        <span class="hljs-keyword">var</span> o2 = toInteger(b)
        <span class="hljs-keyword">var</span> n1 = o1.num
        <span class="hljs-keyword">var</span> n2 = o2.num
        <span class="hljs-keyword">var</span> t1 = o1.times
        <span class="hljs-keyword">var</span> t2 = o2.times
        <span class="hljs-keyword">var</span> max = t1 &gt; t2 ? t1 : t2
        <span class="hljs-keyword">var</span> result = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">switch</span> (op) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'add'</span>:
                <span class="hljs-keyword">if</span> (t1 === t2) { <span class="hljs-comment">// 两个小数位数相同</span>
                    result = n1 + n2
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t1 &gt; t2) { <span class="hljs-comment">// o1 小数位 大于 o2</span>
                    result = n1 + n2 * (t1 / t2)
                } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// o1 小数位 小于 o2</span>
                    result = n1 * (t2 / t1) + n2
                }
                <span class="hljs-keyword">return</span> result / max
            <span class="hljs-keyword">case</span> <span class="hljs-string">'subtract'</span>:
                <span class="hljs-keyword">if</span> (t1 === t2) {
                    result = n1 - n2
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t1 &gt; t2) {
                    result = n1 - n2 * (t1 / t2)
                } <span class="hljs-keyword">else</span> {
                    result = n1 * (t2 / t1) - n2
                }
                <span class="hljs-keyword">return</span> result / max
            <span class="hljs-keyword">case</span> <span class="hljs-string">'multiply'</span>:
                result = (n1 * n2) / (t1 * t2)
                <span class="hljs-keyword">return</span> result
            <span class="hljs-keyword">case</span> <span class="hljs-string">'divide'</span>:
                result = (n1 / n2) * (t2 / t1)
                <span class="hljs-keyword">return</span> result
        }
    }

    <span class="hljs-comment">// 加减乘除的四个接口</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a, b, digits</span>) </span>{
        <span class="hljs-keyword">return</span> operation(a, b, digits, <span class="hljs-string">'add'</span>)
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subtract</span>(<span class="hljs-params">a, b, digits</span>) </span>{
        <span class="hljs-keyword">return</span> operation(a, b, digits, <span class="hljs-string">'subtract'</span>)
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">multiply</span>(<span class="hljs-params">a, b, digits</span>) </span>{
        <span class="hljs-keyword">return</span> operation(a, b, digits, <span class="hljs-string">'multiply'</span>)
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">divide</span>(<span class="hljs-params">a, b, digits</span>) </span>{
        <span class="hljs-keyword">return</span> operation(a, b, digits, <span class="hljs-string">'divide'</span>)
    }

    <span class="hljs-comment">// exports</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">add</span>: add,
        <span class="hljs-attr">subtract</span>: subtract,
        <span class="hljs-attr">multiply</span>: multiply,
        <span class="hljs-attr">divide</span>: divide
    }
}();
<span class="copy-code-btn">复制代码</span></code></pre><p>  如果觉得floatObj调用麻烦，我们可以在Number.prototype上添加对应的运算方法。</p>
<p>如果觉得写得还不错，请关注我的<a style="color:#f63;text-decoration:none;" href="//juejin.im/user/580038cebf22ec0064bd0b2d" target="_blank" rel="">掘金主页</a>。更多文章请访问<a style="color:#f63;text-decoration:none;" href="https://acexyf.github.io" target="_blank" rel="nofollow noopener noreferrer">谢小飞的博客</a></p>
</div></article>